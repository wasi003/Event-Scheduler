{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìÖ Events</h2>
    <a href="/events/add" class="btn btn-success">+ Add Event</a>
</div>

<table class="table table-striped table-hover">
    <thead class="table-dark">
    <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Description</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for e in events %}
    <tr>
        <td><span class="badge bg-secondary">{{ e.event_id }}</span></td>
        <td><strong>{{ e.title }}</strong></td>
        <td>{{ e.start_time.strftime('%Y-%m-%d %H:%M') if e.start_time else 'N/A' }}</td>
        <td>{{ e.end_time.strftime('%Y-%m-%d %H:%M') if e.end_time else 'N/A' }}</td>
        <td>{{ e.description[:50] if e.description else 'No description' }}...</td>
        <td>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editModal" 
                    onclick="loadEventData({{ e.event_id }}, '{{ e.title }}', '{{ e.description or '' }}', '{{ e.start_time.isoformat() if e.start_time else '' }}', '{{ e.end_time.isoformat() if e.end_time else '' }}')">
                ‚úèÔ∏è Edit
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteEvent({{ e.event_id }})">
                üóëÔ∏è Delete
            </button>
        </td>
    </tr>
    {% else %}
    <tr>
        <td colspan="6" class="text-center text-muted">No events found</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Edit Event Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEventForm">
                    <input type="hidden" id="eventId">
                    
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventStartTime" class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-control" id="eventStartTime" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventEndTime" class="form-label">End Time</label>
                        <input type="datetime-local" class="form-control" id="eventEndTime" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateEvent()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function loadEventData(eventId, title, description, startTime, endTime) {
        document.getElementById('eventId').value = eventId;
        document.getElementById('eventTitle').value = title;
        document.getElementById('eventDescription').value = description;
        
        // Convert ISO format to datetime-local format
        if (startTime) {
            const startDate = new Date(startTime);
            document.getElementById('eventStartTime').value = startDate.toISOString().slice(0, 16);
        }
        
        if (endTime) {
            const endDate = new Date(endTime);
            document.getElementById('eventEndTime').value = endDate.toISOString().slice(0, 16);
        }
    }
    
    function updateEvent() {
        const eventId = document.getElementById('eventId').value;
        const data = {
            title: document.getElementById('eventTitle').value,
            description: document.getElementById('eventDescription').value,
            start_time: new Date(document.getElementById('eventStartTime').value).toISOString(),
            end_time: new Date(document.getElementById('eventEndTime').value).toISOString()
        };
        
        fetch(`/api/events/${eventId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.message) {
                alert(result.message);
                if (result.event) {
                    location.reload();
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating event');
        });
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        modal.hide();
    }
    
    function deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this event?')) {
            return;
        }
        
        // Create a form and submit it as POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/events/delete/${eventId}`;
        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock %}
